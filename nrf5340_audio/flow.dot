digraph D{
  # Note: We use the fillcolor attribute to distinguish the different components
  Callbak [fillcolor="#ffff0040", style=filled, shape=box]
  Thread [fillcolor="#ff000040", style=filled, shape=box]
  Simplified [fillcolor="#00000040", style=filled, shape=box]
  Zbus [fillcolor="#0000ff40", style=filled, shape=box]
  Semaphore [fillcolor="#00ff0040", style=filled, shape=box]

  Main -> {WiFi, Audio}
    Main [fillcolor="#ff000040", style=filled]

  # WiFi

  # Audio
  Audio -> "audio_systems_init()"
  "audio_systems_init()" -> "audio_datapath_init()"

  "audio_datapath_init()" -> "audio_i2s_blk_comp_cb_reg(audio_datapaht_i2s_blk_comp_cb)"-> "audio_i2s_init()"
    "audio_i2s_blk_comp_cb_reg(audio_datapaht_i2s_blk_comp_cb)" [fillcolor="#ffff0040", style=filled]

  "audio_i2s_init()" ->"hw_codec_init()"
  "hw_codec_init()" -> "cs47l63_comm_init()" -> "Setup spi" -> "k_thread_create(cs47l63_thread)" -> "cs47l63 setup"
    "k_thread_create(cs47l63_thread)" [fillcolor="#ff000040", style=filled]
    "Setup spi" [fillcolor="#00000040", style=filled]
    "cs47l63 setup" [fillcolor="#00000040", style=filled]
  "cs47l63 setup" -> "k_thread_create(volume_msg_sub_thread)" 
    "k_thread_create(volume_msg_sub_thread)" [fillcolor="#ff000040", style=filled]
  
  "k_thread_create(volume_msg_sub_thread)" -> "k_poll_signal_init(encoder_sig)"

  "k_poll_signal_init(encoder_sig)" -> "audio_system_start()"
  "audio_system_start()" -> "audio_headset_configure()" -> "Init FIFOs" -> "sw_codec_init()" -> "k_thread_create(encoder_thread)"
    "Init FIFOs" [fillcolor="#00000040", style=filled]
    "sw_codec_init()" [fillcolor="#00000040", style=filled]
    "k_thread_create(encoder_thread)" [fillcolor="#ff000040", style=filled]
  "k_thread_create(encoder_thread)" -> "hw_codec_default_conf_enable()" -> "audio_datapath_start()"
    "hw_codec_default_conf_enable()" [fillcolor="#00000040", style=filled]
    "audio_datapath_start()" [fillcolor="#00000040", style=filled] 
    

  # Volume message sub thread
  "volume_msg_sub_thread" -> "zbus_sub_wait(volume_evt_sub)" -> "zbus_chan_read()"-> "Handle volume event" -> "zbus_sub_wait(volume_evt_sub)"
    "zbus_sub_wait(volume_evt_sub)" [fillcolor="#0000ff40", style=filled]
    "zbus_chan_read()" [fillcolor="#0000ff40", style=filled]
    "Handle volume event" [fillcolor="#00000040", style=filled]
    "volume_msg_sub_thread" [fillcolor="#ff000040", style=filled]

  # cs47l63_thread
  "cs47l63_thread" -> "k_sem_take(sem_cs47l63)" -> "cs47l63_process()" -> "k_sem_take(sem_cs47l63)"
    "k_sem_take(sem_cs47l63)" [fillcolor="#00ff0040", style=filled]
    "cs47l63_process()" [fillcolor="#00000040", style=filled]
    "cs47l63_thread" [fillcolor="#ff000040", style=filled]

  # encoder_thread
  "encoder_thread" -> "k_poll(encoder_evt)" -> "Get PCM data from I2S" -> "test tone enabled"
    "k_poll(encoder_evt)" [fillcolor="#00ff0040", style=filled]
    "Get PCM data from I2S" [fillcolor="#00000040", style=filled]
    "test tone enabled" [fillcolor="#00000040", style=filled, shape=diamond]
    "encoder_thread" [fillcolor="#ff000040", style=filled]

  "test tone enabled" -> "replace audio stream"[label="yes"]
  "replace audio stream" -> "sw_codec_encode()"
    "replace audio stream" [fillcolor="#00000040", style=filled]
  "test tone enabled" -> "sw_codec_encode()"[label="no"]
    "sw_codec_encode()" [fillcolor="#00000040", style=filled]
  "sw_codec_encode()" -> "streamctrl_send()" -> "encoder_thread"
  

}